name: Deploy to Testing Environment

# Manual trigger only (as per AI_POLICY.md - human approval required)
on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm deployment to testing'
        required: true
        default: ''

jobs:
  verify-confirmation:
    name: Verify Deployment Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY" ]; then
            echo "ERROR: Deployment not confirmed. Please type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "Deployment confirmed. Proceeding..."

  test-before-deploy:
    name: Run Tests Before Deployment
    needs: verify-confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend linting
        working-directory: ./backend
        run: |
          black --check app tests
          flake8 app tests --max-line-length=100 --extend-ignore=E203,W503

      - name: Run backend tests with coverage
        working-directory: ./backend
        env:
          DB_USER: test_user
          DB_PASSWORD: test_password
          DATABASE: test_db
          SECRET_KEY: test-secret-key-for-ci
        run: |
          pytest --cov=app --cov-report=term-missing --cov-fail-under=70

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in
        run: npm run build

  deploy-backend:
    name: Deploy Backend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Prepare deployment package
        working-directory: ./backend
        run: |
          # Create deployment directory
          mkdir -p deploy/scripts

          # Copy application files
          cp -r app deploy/
          cp -r alembic deploy/
          cp requirements.txt deploy/
          cp alembic.ini deploy/
          cp .env.example deploy/.env.example
          cp scripts/start_server.sh deploy/scripts/start_server.sh
          chmod +x deploy/scripts/start_server.sh

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> deploy/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> deploy/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy backend files to server
        run: |
          rsync -avz --delete \
            --exclude='venv' \
            --exclude='.env' \
            --exclude='api.log' \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./backend/deploy/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/healthapi.gahfaudio.in/public_html/

      - name: Install dependencies, configure env, run migrations
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          cd /home/healthapi.gahfaudio.in/public_html

          # Create virtual environment if not exists
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          # Activate virtual environment
          source venv/bin/activate

          # Install dependencies
          pip install --upgrade pip
          pip install -r requirements.txt

          # Always recreate .env from secrets to keep it in sync
          cat > .env << 'ENVEOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          DATABASE=${{ secrets.DATABASE }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          CORS_ORIGINS=https://health.gahfaudio.in,http://localhost:3000
          ENVIRONMENT=testing
          ENVEOF

          # Run database migrations
          alembic upgrade head || echo "Migration warning (may already be current)"

          EOF

      - name: Start and verify API service
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          cd /home/healthapi.gahfaudio.in/public_html

          chmod +x scripts/start_server.sh
          bash scripts/start_server.sh

          # Wait for startup
          sleep 5

          # Verify the service is actually responding
          curl -f http://127.0.0.1:8022/health || {
            echo "==============================="
            echo "ERROR: API failed to start!"
            echo "==============================="
            echo "Last 200 lines of api.log:"
            tail -n 200 /home/healthapi.gahfaudio.in/public_html/api.log 2>/dev/null || echo "No log file found"
            echo "==============================="
            echo "Running processes:"
            ps aux | grep uvicorn || true
            exit 1
          }
          echo "API is running and healthy on port 8022"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-frontend:
    name: Deploy Frontend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend for testing
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in
        run: |
          npm run build

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > build/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> build/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> build/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy frontend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./frontend/build/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/health.gahfaudio.in/public_html/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  smoke-tests:
    name: Run Smoke Tests
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for services to stabilize
        run: sleep 10

      - name: Test backend health endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://healthapi.gahfaudio.in/health)
          echo "Health endpoint returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: Backend health check failed with HTTP $HTTP_CODE"
            curl -v https://healthapi.gahfaudio.in/health 2>&1 || true
            exit 1
          fi

      - name: Test frontend loads
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://health.gahfaudio.in/)
          echo "Frontend returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: Frontend check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test API root endpoint
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://healthapi.gahfaudio.in/)
          echo "API root returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: API root check failed with HTTP $HTTP_CODE"
            exit 1
          fi

  e2e-tests:
    name: Run Playwright E2E Tests
    needs: smoke-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npx playwright test

  notify-completion:
    name: Notify Deployment Complete
    needs: [smoke-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deployment success notification
        run: |
          echo "=========================================="
          echo "Deployment to Testing Environment Complete"
          echo "=========================================="
          echo ""
          echo "Backend API: https://healthapi.gahfaudio.in"
          echo "Frontend: https://health.gahfaudio.in"
          echo "API Docs: https://healthapi.gahfaudio.in/docs"
          echo ""
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "Next steps:"
          echo "1. Verify deployment manually"
          echo "2. Test core user flows"
          echo "3. Check for console errors"
          echo "4. Approve for production deployment if ready"
          echo "=========================================="

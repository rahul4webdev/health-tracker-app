name: Deploy to Testing Environment

# Manual trigger only (as per AI_POLICY.md - human approval required)
on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm deployment to testing'
        required: true
        default: ''

jobs:
  verify-confirmation:
    name: Verify Deployment Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY" ]; then
            echo "ERROR: Deployment not confirmed. Please type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "Deployment confirmed. Proceeding..."

  test-before-deploy:
    name: Run Tests Before Deployment
    needs: verify-confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend linting
        working-directory: ./backend
        run: |
          black --check app tests
          flake8 app tests --max-line-length=100 --extend-ignore=E203,W503

      - name: Run backend tests with coverage
        working-directory: ./backend
        env:
          DB_USER: test_user
          DB_PASSWORD: test_password
          DATABASE: test_db
          SECRET_KEY: test-secret-key-for-ci
        run: |
          pytest --cov=app --cov-report=term-missing --cov-fail-under=70

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in
        run: npm run build

  deploy-backend:
    name: Deploy Backend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Prepare deployment package
        working-directory: ./backend
        run: |
          # Create deployment directory
          mkdir -p deploy/scripts

          # Copy application files
          cp -r app deploy/
          cp -r alembic deploy/
          cp requirements.txt deploy/
          cp alembic.ini deploy/
          cp .env.example deploy/.env.example
          cp scripts/start_server.sh deploy/scripts/start_server.sh
          chmod +x deploy/scripts/start_server.sh

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> deploy/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> deploy/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy backend files to server
        run: |
          rsync -avz --delete \
            --exclude='venv' \
            --exclude='.env' \
            --exclude='api.log' \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./backend/deploy/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/healthapi.gahfaudio.in/public_html/

      - name: Install dependencies, configure env, run migrations
        env:
          SSH_KEY_PATH: ~/.ssh/deploy_key
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'bash -s' << DEPLOY_ENV
          set -e
          cd /home/healthapi.gahfaudio.in/public_html

          # Create virtual environment if not exists
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          # Activate and install
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # Write .env from secrets (no leading whitespace)
          cat > .env << 'ENVFILE'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          DATABASE=${{ secrets.DATABASE }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          CORS_ORIGINS=https://health.gahfaudio.in,http://localhost:3000
          ENVIRONMENT=testing
          ENVFILE

          # Strip leading whitespace from .env (safety net for HEREDOC indentation)
          sed -i 's/^[[:space:]]*//' .env

          # Verify .env was created with content
          if [ ! -s .env ]; then
            echo "FATAL: .env file is empty after creation"
            exit 1
          fi
          echo ".env created successfully:"
          wc -l .env

          # Run database migrations
          alembic upgrade head || echo "Migration warning (may already be current)"

          DEPLOY_ENV

      - name: Restart API via systemd and verify health
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} 'bash -s' << 'RESTART_SCRIPT'
          set -e

          echo "=== Restarting health-tracker-api service ==="
          systemctl restart health-tracker-api

          # Wait for startup (max 30 seconds)
          echo "Waiting for API to start..."
          for i in $(seq 1 30); do
            if curl -sf http://127.0.0.1:8022/health > /dev/null 2>&1; then
              echo "API is healthy after ${i}s"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "==============================="
              echo "FATAL: API failed to start within 30s"
              echo "==============================="
              echo "--- systemd status ---"
              systemctl status health-tracker-api --no-pager || true
              echo "--- journal (last 50 lines) ---"
              journalctl -u health-tracker-api --no-pager -n 50 || true
              echo "--- api.log (last 50 lines) ---"
              tail -50 /home/healthapi.gahfaudio.in/public_html/api.log 2>/dev/null || true
              echo "--- processes ---"
              ps aux | grep uvicorn || true
              exit 1
            fi
            sleep 1
          done

          # Verify critical endpoints
          echo "=== Verifying /health ==="
          curl -f http://127.0.0.1:8022/health
          echo ""

          echo "=== Verifying / ==="
          curl -f http://127.0.0.1:8022/
          echo ""

          echo "=== Verifying /docs ==="
          curl -sf -o /dev/null -w "HTTP %{http_code}" http://127.0.0.1:8022/docs
          echo ""

          echo "=== Verifying process is running ==="
          PID=$(pgrep -f "uvicorn app.main:app.*8022" || true)
          if [ -z "$PID" ]; then
            echo "FATAL: No uvicorn process found on port 8022"
            exit 1
          fi
          echo "uvicorn running with PID: $PID"

          echo "=== All local checks passed ==="
          RESTART_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-frontend:
    name: Deploy Frontend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend for testing
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in
        run: |
          npm run build

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > build/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> build/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> build/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy frontend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./frontend/build/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/health.gahfaudio.in/public_html/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  smoke-tests:
    name: Run Smoke Tests (Hard Gate)
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for services to stabilize
        run: sleep 10

      - name: "GATE: Backend health endpoint must return 200"
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 https://healthapi.gahfaudio.in/health)
          echo "Health endpoint returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: Backend health check failed with HTTP $HTTP_CODE"
            curl -v --max-time 10 https://healthapi.gahfaudio.in/health 2>&1 || true
            exit 1
          fi

      - name: "GATE: API root endpoint must return 200"
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 https://healthapi.gahfaudio.in/)
          echo "API root returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: API root check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: "GATE: API docs must return 200"
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 https://healthapi.gahfaudio.in/docs)
          echo "API docs returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: API docs check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: "GATE: CORS headers must be present for frontend origin"
        run: |
          CORS_HEADER=$(curl -s -D - -o /dev/null --max-time 15 \
            -H "Origin: https://health.gahfaudio.in" \
            -H "Access-Control-Request-Method: GET" \
            -X OPTIONS \
            https://healthapi.gahfaudio.in/health \
            | grep -i "access-control-allow-origin" || true)
          echo "CORS header: $CORS_HEADER"
          if [ -z "$CORS_HEADER" ]; then
            echo "FATAL: No CORS Access-Control-Allow-Origin header returned"
            echo "Checking with GET request..."
            curl -s -D - -o /dev/null --max-time 10 \
              -H "Origin: https://health.gahfaudio.in" \
              https://healthapi.gahfaudio.in/health | grep -i "access-control" || true
            exit 1
          fi
          echo "CORS is properly configured"

      - name: "GATE: DEPLOY_INFO.txt must be accessible"
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 https://healthapi.gahfaudio.in/DEPLOY_INFO.txt)
          echo "DEPLOY_INFO.txt returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: DEPLOY_INFO.txt not accessible (HTTP $HTTP_CODE)"
            exit 1
          fi
          CONTENT=$(curl -sf --max-time 10 https://healthapi.gahfaudio.in/DEPLOY_INFO.txt)
          echo "$CONTENT"
          if ! echo "$CONTENT" | grep -q "GIT_COMMIT"; then
            echo "FATAL: DEPLOY_INFO.txt does not contain GIT_COMMIT"
            exit 1
          fi
          echo "DEPLOY_INFO.txt is accessible and contains commit info"

      - name: "GATE: CORS must return exact frontend origin (no wildcard)"
        run: |
          ORIGIN_HEADER=$(curl -sf -D - -o /dev/null --max-time 15 \
            -H "Origin: https://health.gahfaudio.in" \
            https://healthapi.gahfaudio.in/health \
            | grep -i "access-control-allow-origin" || true)
          echo "CORS origin header: $ORIGIN_HEADER"
          if ! echo "$ORIGIN_HEADER" | grep -q "https://health.gahfaudio.in"; then
            echo "FATAL: CORS does not return https://health.gahfaudio.in"
            echo "Got: $ORIGIN_HEADER"
            exit 1
          fi
          if echo "$ORIGIN_HEADER" | grep -q "\*"; then
            echo "FATAL: CORS uses wildcard (*) â€” must be explicit origin"
            exit 1
          fi
          echo "CORS correctly returns exact origin (no wildcard)"

      - name: "GATE: Frontend must return 200"
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 15 https://health.gahfaudio.in/)
          echo "Frontend returned: $HTTP_CODE"
          if [ "$HTTP_CODE" != "200" ]; then
            echo "FATAL: Frontend check failed with HTTP $HTTP_CODE"
            exit 1
          fi

      - name: "GATE: Frontend content must be HTML"
        run: |
          CONTENT_TYPE=$(curl -s -D - -o /dev/null --max-time 15 https://health.gahfaudio.in/ | grep -i "content-type" || true)
          echo "Content-Type: $CONTENT_TYPE"
          if ! echo "$CONTENT_TYPE" | grep -qi "text/html"; then
            echo "FATAL: Frontend is not serving HTML"
            exit 1
          fi

  e2e-tests:
    name: Run Playwright E2E Tests
    needs: smoke-tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        working-directory: ./frontend
        run: npx playwright test

  notify-completion:
    name: Notify Deployment Complete
    needs: [smoke-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deployment success notification
        run: |
          echo "=========================================="
          echo "Deployment to Testing Environment Complete"
          echo "=========================================="
          echo ""
          echo "Backend API: https://healthapi.gahfaudio.in"
          echo "Frontend: https://health.gahfaudio.in"
          echo "API Docs: https://healthapi.gahfaudio.in/docs"
          echo ""
          echo "All smoke tests PASSED:"
          echo "  - /health returns 200"
          echo "  - / returns 200"
          echo "  - /docs returns 200"
          echo "  - CORS headers present"
          echo "  - Frontend serves HTML"
          echo ""
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "=========================================="

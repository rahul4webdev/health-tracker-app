name: Deploy to Testing Environment

# Manual trigger only (as per AI_POLICY.md - human approval required)
on:
  workflow_dispatch:
    inputs:
      confirm_deployment:
        description: 'Type "DEPLOY" to confirm deployment to testing'
        required: true
        default: ''

jobs:
  verify-confirmation:
    name: Verify Deployment Confirmation
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_deployment }}" != "DEPLOY" ]; then
            echo "ERROR: Deployment not confirmed. Please type 'DEPLOY' to confirm."
            exit 1
          fi
          echo "Deployment confirmed. Proceeding..."

  test-before-deploy:
    name: Run Tests Before Deployment
    needs: verify-confirmation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install backend dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run backend linting
        working-directory: ./backend
        run: |
          black --check app tests
          flake8 app tests --max-line-length=100 --extend-ignore=E203,W503

      - name: Run backend tests with coverage
        working-directory: ./backend
        env:
          DB_USER: test_user
          DB_PASSWORD: test_password
          DATABASE: test_db
          SECRET_KEY: test-secret-key-for-ci
        run: |
          pytest --cov=app --cov-report=term-missing --cov-fail-under=70

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in:8022
        run: npm run build

  deploy-backend:
    name: Deploy Backend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Prepare deployment package
        working-directory: ./backend
        run: |
          # Create deployment directory
          mkdir -p deploy

          # Copy application files
          cp -r app deploy/
          cp -r alembic deploy/
          cp requirements.txt deploy/
          cp alembic.ini deploy/
          cp .env.example deploy/.env.example

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > deploy/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> deploy/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> deploy/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy backend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./backend/deploy/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/healthapi.gahfaudio.in/public_html/

      - name: Install dependencies and run migrations on server
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }} \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          cd /home/healthapi.gahfaudio.in/public_html

          # Create virtual environment if not exists
          if [ ! -d "venv" ]; then
            python3 -m venv venv
          fi

          # Activate virtual environment
          source venv/bin/activate

          # Install dependencies
          pip install --upgrade pip
          pip install -r requirements.txt

          # Create .env file from secrets (if not exists)
          if [ ! -f ".env" ]; then
            cat > .env << 'ENVEOF'
          DB_HOST=${{ secrets.DB_HOST }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_PORT=${{ secrets.DB_PORT }}
          DATABASE=${{ secrets.DATABASE }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          ENVIRONMENT=testing
          ENVEOF
          fi

          # Run database migrations
          alembic upgrade head

          # Restart application (adjust based on process manager)
          # Using systemd service (example)
          sudo systemctl restart health-tracker-api || echo "Service restart skipped (configure systemd first)"

          # OR using screen/tmux (alternative)
          # pkill -f "uvicorn app.main:app"
          # screen -dmS health-tracker-api venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8022

          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  deploy-frontend:
    name: Deploy Frontend to Testing
    needs: test-before-deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend for testing
        working-directory: ./frontend
        env:
          REACT_APP_API_URL: https://healthapi.gahfaudio.in:8022
        run: |
          npm run build

          # Create deployment info
          echo "DEPLOYED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)" > build/DEPLOY_INFO.txt
          echo "GIT_COMMIT=${{ github.sha }}" >> build/DEPLOY_INFO.txt
          echo "DEPLOYED_BY=${{ github.actor }}" >> build/DEPLOY_INFO.txt

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy frontend files to server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -p ${{ secrets.SSH_PORT }}" \
            ./frontend/build/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/health.gahfaudio.in/public_html/

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

  smoke-tests:
    name: Run Smoke Tests
    needs: [deploy-backend, deploy-frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Wait for services to start
        run: sleep 10

      - name: Test backend health endpoint
        run: |
          curl -f https://healthapi.gahfaudio.in:8022/health || \
          curl -f http://healthapi.gahfaudio.in:8022/health || \
          echo "WARNING: Health check failed - verify manually"

      - name: Test frontend loads
        run: |
          curl -f -I https://health.gahfaudio.in/ || \
          curl -f -I http://health.gahfaudio.in/ || \
          echo "WARNING: Frontend check failed - verify manually"

      - name: Test API root endpoint
        run: |
          curl -f https://healthapi.gahfaudio.in:8022/ || \
          curl -f http://healthapi.gahfaudio.in:8022/ || \
          echo "WARNING: API root check failed - verify manually"

  notify-completion:
    name: Notify Deployment Complete
    needs: smoke-tests
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Deployment success notification
        run: |
          echo "=========================================="
          echo "Deployment to Testing Environment Complete"
          echo "=========================================="
          echo ""
          echo "Backend API: https://healthapi.gahfaudio.in:8022"
          echo "Frontend: https://health.gahfaudio.in"
          echo "API Docs: https://healthapi.gahfaudio.in:8022/docs"
          echo ""
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "Next steps:"
          echo "1. Verify deployment manually"
          echo "2. Test core user flows"
          echo "3. Check for console errors"
          echo "4. Approve for production deployment if ready"
          echo "=========================================="
